<!doctype html>
<html>
<head>
<meta name="viewport" content="user-scalable=no, width=device-width, height=device-height">
<title>PowPow Controls</title>
<style>
html, body {
  width: 100%;
  height: 100%;
  border: 0px;
  padding: 0px;
  margin: 0px;
  background-color: blue;
  font-family: sans-serif;
}
#surface {
  width: 100%;
  height: 100%;
  background-color: green;
}
#status {
  gbackground-color: red;
  width: 100%;
  height: 300px;
  overflow: auto;
}
#touchControls {
  position: absolute;
  top: 0px;
  left: 0px;
  z-index: 2;
  width: 100%;
  height: 100%;
}
#singleTouchControls {
  position: absolute;
  top: 0px;
  left: 0px;
  z-index: 3;
  width: 100%;
  height: 100%;
  display: none;
  background: url(assets/arrows.png) no-repeat center;
}
#singleTouchControls .canvas {
  position relative;
  z-index: 4;
  border: 2px solid yellow;
}
#keyControls {
  position: absolute;
  top: 0px;
  left: 0px;
  z-index: 3;
  width: 100%;
  height: 100%;
  display: none;
}
.move {
  float: left;
  width: 50%;
  height: 100%;
  vertical-align: middle;
  color: black;
  background-color: rgba(255, 255, 255, 0.2);
  display: table-cell;
}
.fire {
  float: right;
  width: 50%;
  height: 100%;
  vertical-align: middle;
  color: white;
  background-color: rgba(0, 0, 0, 0.2);
}
#singleTouchControls .move {
  width: 100%;
}
#top {
  position: absolute;
  top: 0px;
  left: 0px;
  z-index: 4;
  width: 100%;
  height: 100%;
}
#text {
  background-color: black;
}
#input {
  display: none;
}
</style>
<link rel="stylesheet" media="all and (max-device-width: 480px)" href="phone.css">
<link rel="stylesheet" media="all and (min-device-width: 481px) and (max-device-width: 1024px) and (orientation:portrait)" href="tablet-portrait.css">
<link rel="stylesheet" media="all and (min-device-width: 481px) and (max-device-width: 1024px) and (orientation:landscape)" href="tablet-landscape.css">
<link rel="stylesheet" media="screen" href="monitor.css">
<script type="text/javascript" src="../socket.io/socket.io.js"></script>
<script type="text/javascript" src="tdl/base.js"></script>
<script>
tdl.require('tdl.log');
window.onload = main;

var g_name = "";
var g_socket;
var g_turn = 0;
var g_oldTurn = 0;
var g_left = false;
var g_right = false;
var g_fire = false;
var g_keyState = {};
var g_oldKeyState = {};
var g_dirTouchStart = 0;
var g_numTouches = 0;
var g_ctx = 0;
var g_canvas;
var g_startX;
var g_startY;

function $(id) {
  return document.getElementById(id);
}

function logTo(id, str) {
  var c = $(id);
  var d = document.createElement("div");
  d.appendChild(document.createTextNode(str));
  c.appendChild(d);
  while(d.children.length > 6) {
    d.removeChild(d.firstChild);
  }
}

function log() {
  var s = ""
  for (var ii = 0; ii < arguments.length; ++ii) {
    s += arguments[ii].toString();
  }
  logTo("console", s);
}

function createCookie(name,value,days) {
	if (days) {
		var date = new Date();
		date.setTime(date.getTime()+(days*24*60*60*1000));
		var expires = "; expires="+date.toGMTString();
	}
	else var expires = "";
	document.cookie = name+"="+value+expires+"; path=/";
}

function readCookie(name) {
	var nameEQ = name + "=";
	var ca = document.cookie.split(';');
	for(var i=0;i < ca.length;i++) {
		var c = ca[i];
		while (c.charAt(0)==' ') c = c.substring(1,c.length);
		if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
	}
	return null;
}

function eraseCookie(name) {
	createCookie(name,"",-1);
}

function connect(server, port) {
  if (!window.io) {
    g_socket = {
      send: function() { }
    };
    return;
  }
  var server = window.location.href.match(/\/\/(.*?)\//)[1];
  var port = 8080;
  g_socket = new io.Socket(null, {
      port: port,
      transports: [
        'websocket',
        'server-events',
        'htmlfile',
        'xhr-multipart',
        'xhr-polling'
      ]});
  g_socket.connect();
  g_socket.on('message', function(obj) {
    processMessage(obj);
  });
}

function sendCmd(cmd, data) {
  g_socket.send({
    cmd: cmd,
    data: data
  });
}

function processMessage(msg) {
  switch (msg.cmd) {
  case 'setColor':
    var e = $("surface");
    e.style.backgroundColor = msg.color;
    break;
  case 'setName':
    g_name = msg.name;
    $('msg').innerHTML = "Name: " + g_name + " -- click to edit";
    $('msg').style.color = '#FFF';
    $('input').value = g_name;
    break;
  case 'kill':
    $('msg').innerHTML = 'Killed ' + msg.killed;
    $('msg').style.color = '#0FF';
    break;
  case 'die':
    $('msg').innerHTML = 'Killed by ' + msg.killer;
    $('msg').style.color = '#F00';
    break;
  case 'launch':
    $('msg').innerHTML = 'Launch!';
    $('msg').style.color = '#FF0';
    break;
  case 'queue':
    $('msg').innerHTML = msg.count > 0 ?
        (msg.count.toString() + " ahead of you") : "Next Up";
    $('msg').style.color = '#FFF';
    break;
  }
}

function debugTouch(label, event) {
  var allTouches = event.touches;
  logTo("status", label);
  for (var ii = 0; ii < allTouches.length; ++ii) {
    var touch = allTouches[ii];
    logTo("status", "  " + ii + ": " + touch.pageX + ", " + touch.pageY +
          " cw: " + event.target.clientWidth +
          " ch: " + event.target.clientHeight);
  }
  var s = $("status");
  s.scrollTop = s.scrollHeight;
}

function touchStart(event) {
  event.preventDefault();
  var allTouches = event.touches;
  var width = event.target.clientWidth;
  var halfWidth = width * 0.5;
  for (var ii = 0; ii < allTouches.length; ++ii) {
    ++g_numTouches;
    var touch = allTouches[ii];
    if (touch.pageX < halfWidth) {
      g_dirTouchStart = touch.pageX;
    } else {
      if (!g_fire) {
        g_fire = true;
        sendCmd("update", {
            cmd: 'fire',
            fire: 1
        });
      }
    }
  }

  debugTouch("start", event);
}

function touchMove(event) {
  event.preventDefault();
  var allTouches = event.touches;
  var width = event.target.clientWidth;
  var halfWidth = width * 0.5;
  for (var ii = 0; ii < allTouches.length; ++ii) {
    var touch = allTouches[ii];
    if (touch.pageX < halfWidth) {
      var dx = touch.pageX - g_dirTouchStart;
      if (dx < -15) {
        if (!g_left) {
          g_left = 1;
          g_right = 0;
          sendCmd("update", {
              cmd: 'turn',
              turn: -1
          });
        }
      } else if (dx > 15) {
        if (!g_right) {
          g_left = 0;
          g_right = 1;
          sendCmd("update", {
              cmd: 'turn',
              turn: 1
          });
        }
      } else {
        if (g_right || g_left) {
          g_left = 0;
          g_right = 0;
          sendCmd("update", {
              cmd: 'turn',
              turn: 0
          });
        }
      }
    }
  }
  debugTouch("move", event);
}

function touchEnd(event) {
  event.preventDefault();

  var allTouches = event.touches;
  var width = event.target.clientWidth;
  var halfWidth = width * 0.5;
  for (var ii = 0; ii < allTouches.length; ++ii) {
    --g_numTouches;
    var touch = allTouches[ii];
    if (touch.pageX < halfWidth) {
      if (g_right || g_left) {
        g_left = 0;
        g_right = 0;
        sendCmd("update", {
            cmd: 'turn',
            turn: 0
        });
      }
    } else {
      if (g_fire) {
        g_fire = false;
        sendCmd("update", {
            cmd: 'fire',
            fire: 0
        });
      }
    }
  }

  if (g_numTouches == 0) {
    if (g_right || g_left) {
      g_left = 0;
      g_right = 0;
      sendCmd("update", {
          cmd: 'turn',
          turn: 0
      });
    }
    if (g_fire) {
      g_fire = false;
      sendCmd("update", {
          cmd: 'fire',
          fire: 0
      });
    }
  }

  debugTouch("end", event);
}

function touchCancel(event) {
  event.preventDefault();
  debugTouch("cancel", event);
}

function updateTarget(element, x, y) {
  var centerX = element.clientWidth / 2;
  var centerY = element.clientWidth / 2;
  var dx = x - centerX;
  var dy = y - centerY;
  var direction = Math.atan2(dy, dx);
  sendCmd("update", {
      cmd: 'target',
      target: (direction + Math.PI / 2 * 3) % (Math.PI * 2)
  });

  var ctx = g_ctx;
  ctx.clearRect(0, 0, g_canvas.width, g_canvas.height);
  ctx.save();
  ctx.translate(g_canvas.width / 2, g_canvas.height / 2);
  ctx.rotate(direction - Math.PI / 2);
  ctx.fillStyle = "#FF0";
  ctx.beginPath();
  ctx.closePath();
  ctx.moveTo(10, 0);
  ctx.lineTo(10, 100);
  ctx.lineTo(30, 100);
  ctx.lineTo(0, 140);
  ctx.lineTo(-30, 100);
  ctx.lineTo(-10, 100);
  ctx.lineTo(-10, 00);
  ctx.closePath();
  ctx.fill();
  ctx.restore();

};

function singleTouchStart(event) {
  event.preventDefault();
  sendCmd("update", {
      cmd: 'fire',
      fire: 1
  });
  updateTarget(event.target, event.touches[0].pageX, event.touches[0].pageY);
}

function singleTouchMove(event) {
  event.preventDefault();
  updateTarget(event.target, event.touches[0].pageX, event.touches[0].pageY);
}

function singleTouchEnd(event) {
  event.preventDefault();
  sendCmd("update", {
      cmd: 'fire',
      fire: 0
  });
  sendCmd("update", {
      cmd: 'target',
      target: -1
  });
}

function singleTouchCancel(event) {
  event.preventDefault();
  sendCmd("update", {
      cmd: 'fire',
      fire: 0
  });
  sendCmd("update", {
      cmd: 'target',
      target: -1
  });
}


function handleKeyDown(keyCode, state) {
  switch(event.keyCode) {
  case 37: // left
    if (!g_left) {
      g_left = true;
      sendCmd("update", {
          cmd: 'turn',
          turn: -1
      });
    }
    break;
  case 39: // right
    if (!g_right) {
      g_right = true;
      sendCmd("update", {
          cmd: 'turn',
          turn: 1
      });
    }
    break;
  case 90: // z
    if (!g_fire) {
      g_fire = true;
      sendCmd("update", {
          cmd: 'fire',
          fire: 1
      });
    }
    break;
  }
}

function handleKeyUp(keyCode, state) {
  switch(event.keyCode) {
  case 37: // left
    g_left = false;
    sendCmd("update", {
        cmd: 'turn',
        turn: (g_right) ? 1 : 0
    });
    break;
  case 39: // right
    g_right = false;
    sendCmd("update", {
        cmd: 'turn',
        turn: (g_left) ? -1 : 0
    });
    break;
  case 90: // z
    g_fire = false;
    sendCmd("update", {
        cmd: 'fire',
        fire: 0
    });
    break;
  }
}

function updateKey(keyCode, state) {
  g_keyState[keyCode] = state;
  if (g_oldKeyState != g_keyState) {
    g_oldKeyState = state;
    if (state) {
      handleKeyDown(keyCode);
    } else {
      handleKeyUp(keyCode);
    }
  }
}

function keyUp(event) {
  //logTo("status", "keyUp: " + event.keyCode);
  var s = $("status");
  s.scrollTop = s.scrollHeight;
  updateKey(event.keyCode, false);
}

function keyDown(event) {
  //logTo("status", "keyDown: " + event.keyCode);
  var s = $("status");
  s.scrollTop = s.scrollHeight;
  updateKey(event.keyCode, true);
}

function enterName(event) {
  $('msg').style.display = "none";
  $('msg').style.color = "#FFF";
  $('input').style.display = "block";
  sendCmd("update", {
      cmd: 'busy',
      busy: true
  });
}

function sendName() {
  sendCmd("update", {
      cmd: 'name',
      name: g_name
  });
  $('msg').innerHTML = g_name;
}

function finishSendName(event) {
  g_name = $('input').value.replace(/[<>]/g, '');
  createCookie("name", g_name, 90);
  tdl.log("name: ", g_name);
  sendName(event);
  $('msg').style.display = "block";
  $('input').style.display = "none";
  sendCmd("update", {
      cmd: 'busy',
      busy: false
  });
}

function main() {
  connect();

  // Get the name user set before.
  g_name = readCookie("name");
  if (!g_name) {
    g_name = "";
  }
  // Note: If the name is "" server will send a name
  sendName();

  var haveTouch = 'ontouchstart' in document

  var surface = $("top");
  if (haveTouch) {
    if (navigator.userAgent.indexOf("Android") >= 0 && !window.opera) {
      var singleTouchControls = $("singleTouchControls");
      var touchControls = $("touchControls");
      singleTouchControls.style.display = "block";
      touchControls.style.display = "none";
      surface.addEventListener("touchstart", singleTouchStart, false);
      surface.addEventListener("touchmove", singleTouchMove, false);
      surface.addEventListener("touchend", singleTouchEnd, false);
      surface.addEventListener("touchcancel", singleTouchCancel, false);
      g_canvas = document.getElementsByTagName("canvas")[0];
      g_ctx = g_canvas.getContext("2d");
    } else {
      surface.addEventListener("touchstart", touchStart, false);
      surface.addEventListener("touchmove", touchMove, false);
      surface.addEventListener("touchend", touchEnd, false);
      surface.addEventListener("touchcancel", touchCancel, false);
    }
  } else {
    var keyControls = $("keyControls");
    var touchControls = $("touchControls");
    keyControls.style.display = "block";
    touchControls.style.display = "none";
    window.addEventListener("keyup", keyUp, false);
    window.addEventListener("keydown", keyDown, false);
  }
  $('msg').addEventListener("click", enterName, false);
  $('input').addEventListener("change", finishSendName, false);
  $('input').addEventListener("blur", finishSendName, false);
}
</script>
</head>
<body>
<div id="surface">
  <div id="status"></div>
  <div id="console">
  </div>
</div>
<div id="touchControls">
  <div class="move">
    <div class="instruction">Press here to Move and Steer</div>
  </div>
  <div class="fire">
    <div class="instruction">Press here to Fire</div>
  </div>
</div>
<div id="singleTouchControls">
  <div class="move">
    <div class="instruction">Press to Steer, Tap to Fire</div>
    <canvas class="canvas" width="300" height="300"></canvas>
  </div>
</div>
<div id="keyControls">
  <div id="text">
    <div id="msg">msg</div>
    <input type="text" id="input" />
  </div>
  <div class="move">
    <div class="instruction">Press Cursor Keys to Steer</div>
  </div>
  <div class="fire">
    <div class="instruction">Press Z to Fire</div>
  </div>
</div>
<!--
<div id="top">
</div>
-->
</body>
</html>


