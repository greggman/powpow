<!doctype html>
<html>
<head>
<meta name="viewport" content="user-scalable=no, width=device-width, height=device-height">
<title>PowPow Controls</title>
<link rel="stylesheet" media="all and (max-device-width: 480px)" href="phone.css">
<link rel="stylesheet" media="all and (min-device-width: 481px) and (max-device-width: 1024px) and (orientation:portrait)" href="tablet-portrait.css">
<link rel="stylesheet" media="all and (min-device-width: 481px) and (max-device-width: 1024px) and (orientation:landscape)" href="tablet-landscape.css">
<link rel="stylesheet" media="all and (min-device-width: 1025px)" href="monitor.css">
<style>
html, body {
  width: 100%;
  height: 100%;
  border: 0px;
  padding: 0px;
  margin: 0px;
  background-color: blue;
  font-family: sans-serif;
}
#surface {
  width: 100%;
  height: 100%;
  background-color: green;
}
#status {
  gbackground-color: red;
  width: 100%;
  height: 300px;
  overflow: auto;
}
#touchControls {
  position: absolute;
  top: 0px;
  left: 0px;
  z-index: 2;
  width: 100%;
  height: 100%;
}
#keyControls {
  position: absolute;
  top: 0px;
  left: 0px;
  z-index: 3;
  width: 100%;
  height: 100%;
  display: none;
}
#move {
  float: left;
  width: 50%;
  height: 100%;
  vertical-align: middle;
  color: black;
  background-color: rgba(255, 255, 255, 0.2);
  display: table-cell;
}
#fire {
  float: right;
  width: 50%;
  height: 100%;
  vertical-align: middle;
  color: white;
  background-color: rgba(0, 0, 0, 0.2);
}
#top {
  position: absolute;
  top: 0px;
  left: 0px;
  z-index: 4;
  width: 100%;
  height: 100%;
}
</style>
<script type="text/javascript" src="../socket.io/socket.io.js"></script>
<script type="text/javascript" src="../tdl/base.js"></script>
<script>
window.onload = main;

var g_socket;
var g_turn = 0;
var g_oldTurn = 0;
var g_left = false;
var g_right = false;
var g_fire = false;
var g_keyState = {};
var g_oldKeyState = {};

function logTo(id, str) {
  var c = document.getElementById(id);
  var d = document.createElement("div");
  d.appendChild(document.createTextNode(str));
  c.appendChild(d);
}

function log() {
  var s = ""
  for (var ii = 0; ii < arguments.length; ++ii) {
    s += arguments[ii].toString();
  }
  logTo("console", s);
}

function connect(server, port) {
  var server = window.location.href.match(/\/\/(.*?)\//)[1];
  var port = 8080;
  g_socket = new io.Socket(null, {
      port: port,
      transports: [
        'websocket',
        'server-events',
        'htmlfile',
        'xhr-multipart',
        'xhr-polling'
      ]});
  g_socket.connect();
  g_socket.on('message', function(obj) {
    processMessage(obj);
  });
}

function sendCmd(cmd, data) {
  g_socket.send({
    cmd: cmd,
    data: data
  });
}

function processMessage(msg) {
  switch (msg.cmd) {
  case 'setColor':
    var e = document.getElementById("surface");
    e.style.backgroundColor = msg.color;
    break;
  case 'win':
    break;
  case 'lose':
    break;
  }
}

function debugTouch(label, event) {
  var allTouches = event.touches;
  logTo("status", label);
  for (var ii = 0; ii < allTouches.length; ++ii) {
    var touch = allTouches[ii];
    logTo("status", "  " + ii + ": " + touch.pageX + ", " + touch.pageY);
  }
  var s = document.getElementById("status");
  s.scrollTop = s.scrollHeight;
}

function touchStart(event) {
  event.preventDefault();
  debugTouch("start", event);
}

function touchMove(event) {
  event.preventDefault();
  debugTouch("move", event);
}

function touchEnd(event) {
  event.preventDefault();
  debugTouch("end", event);
}

function touchCancel(event) {
  event.preventDefault();
  debugTouch("cancel", event);
}

function handleKeyDown(keyCode, state) {
  switch(event.keyCode) {
  case 37: // left
    if (!g_left) {
      g_left = true;
      sendCmd("update", {
          cmd: 'turn',
          turn: -1
      });
    }
    break;
  case 39: // right
    if (!g_right) {
      g_right = true;
      sendCmd("update", {
          cmd: 'turn',
          turn: 1
      });
    }
    break;
  case 90: // z
    if (!g_fire) {
      g_fire = true;
      sendCmd("update", {
          cmd: 'fire',
          fire: 1
      });
    }
    break;
  }
}

function handleKeyUp(keyCode, state) {
  switch(event.keyCode) {
  case 37: // left
    g_left = false;
    sendCmd("update", {
        cmd: 'turn',
        turn: (g_right) ? 1 : 0
    });
    break;
  case 39: // right
    g_right = false;
    sendCmd("update", {
        cmd: 'turn',
        turn: (g_left) ? -1 : 0
    });
    break;
  case 90: // z
    g_fire = false;
    sendCmd("update", {
        cmd: 'fire',
        fire: 0
    });
    break;
  }
}

function updateKey(keyCode, state) {
  g_keyState[keyCode] = state;
  if (g_oldKeyState != g_keyState) {
    g_oldKeyState = state;
    if (state) {
      handleKeyDown(keyCode);
    } else {
      handleKeyUp(keyCode);
    }
  }
}

function keyUp(event) {
  //logTo("status", "keyUp: " + event.keyCode);
  var s = document.getElementById("status");
  s.scrollTop = s.scrollHeight;
  updateKey(event.keyCode, false);
}

function keyDown(event) {
  //logTo("status", "keyDown: " + event.keyCode);
  var s = document.getElementById("status");
  s.scrollTop = s.scrollHeight;
  updateKey(event.keyCode, true);
}

function main() {
  connect();

  var haveTouch = 'ontouchstart' in document

  var surface = document.getElementById("top");
  if (haveTouch) {
    surface.addEventListener("touchstart", touchStart, false);
    surface.addEventListener("touchmove", touchMove, false);
    surface.addEventListener("touchend", touchEnd, false);
    surface.addEventListener("touchcancel", touchCancel, false);
  } else {
    var keyControls = document.getElementById("keyControls");
    var touchControls = document.getElementById("touchControls");
    log(touchControls.style.display);
    keyControls.style.display = "block";
    touchControls.style.display = "none";
    window.addEventListener("keyup", keyUp, false);
    window.addEventListener("keydown", keyDown, false);
  }
}
</script>
</head>
<body>
<div id="surface">
  <div id="status"></div>
  <div id="console">
  </div>
</div>
<div id="touchControls">
  <div id="move">
    <div class="msg">Press here to Move and Steer</div>
  </div>
  <div id="fire">
    <div class="msg">Press here to Fire</div>
  </div>
</div>
<div id="keyControls">
  <div id="move">
    <div class="msg">Press Cursor Keys to Steer</div>
  </div>
  <div id="fire">
    <div class="msg">Press Z to Fire</div>
  </div>
</div>
<div id="top">
</div>
</body>
</html>


