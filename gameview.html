<!doctype html>
<html>
<head>
<title>PowPow</title>
<style>
html, body {
  width: 100%;
  height: 100%;
  border: 0px;
  padding: 0px;
  margin: 0px;
  background-color: yellow;
  font-family: sans-serif;
}
#outer {
  width: 100%;
  height: 100%;
}
#canvas {
  width: 100%;
  height: 100%;
}
</style>
<!-- Note: Socket IO is served from the socket io based server -->
<script type="text/javascript" src="socket.io/socket.io.js"></script>
<script type="text/javascript" src="tdl/base.js"></script>
<script>
tdl.require('tdl.log');
tdl.require('tdl.webgl');

window.onload = main;

var g_canvas;
var g_ctx;
var g_clock;
var g_socket;
var g_players = {};
var g_numPlayers = 0;

function logTo(id, str) {
  var c = document.getElementById(id);
  var d = document.createElement("div");
  d.appendChild(document.createTextNode(str));
  c.appendChild(d);
}

function log() {
  var s = ""
  for (var ii = 0; ii < arguments.length; ++ii) {
    s += arguments[ii].toString();
  }
  logTo("console", s);
}

function connect(server, port) {
  var server = window.location.href.match(/\/\/(.*?)\//)[1];
  var port = 8080;
  g_socket = new io.Socket(null, {
      port: port,
      transports: ['websocket']});
  g_socket.connect();
  g_socket.on('message', function(obj) {
    processMessage(obj);
  });
}

function processMessage(msg) {
  switch (msg.cmd) {
  case 'update':
    updatePlayer(msg.id, msg.data);
    break;
  case 'remove':
    removePlayer(msg.id);
    break;
  }
}

function Player(id) {
  this.id = id;
  this.position = [100, 100];
  this.hp = 3;
  this.color = "#0000ff";
  this.turn = 0;
  this.direction = 0;
  this.fire = false;
  this.vel = 200;
  this.turnVel = Math.PI * 0.5;
}

Player.prototype.update = function(msg) {
  switch (msg.cmd) {
    case 'turn':
      this.turn = msg.turn;
      break;
    case 'fire':
      this.fire = msg.fire;
      break;
  }
};

Player.prototype.process = function(elapsedTime) {
  this.direction += this.turnVel * this.turn * elapsedTime;
  var dx = Math.sin(this.direction) * this.vel * elapsedTime;
  var dy = Math.cos(this.direction) * this.vel * elapsedTime;
  updatePos(this.position, dx, dy);
};

Player.prototype.draw = function(ctx) {
  ctx.save();
  ctx.translate(this.position[0], this.position[1]);
  ctx.rotate(this.direction);
  ctx.fillStyle = this.color;
  ctx.beginPath();
  ctx.closePath();
  ctx.moveTo(0, 15);
  ctx.lineTo(15, -15);
  ctx.lineTo(0, -10);
  ctx.lineTo(-15, -15);
  ctx.closePath();
  ctx.fill();
  ctx.restore();
};

function updatePos(pos, dx, dy) {
  var x = pos[0] + dx;
  if (x < 0) {
    x = g_canvas.width - 1;
  } else if (x >= g_canvas.width) {
    x = 0;
  }

  var y = pos[1] + dy;
  if (y < 0) {
    y = g_canvas.height - 1;
  } else if (y >= g_canvas.height) {
    y = 0;
  }

  pos[0] = x;
  pos[1] = y;
}

function getPlayer(id) {
  var player = g_players[id];
  if (!player) {
    player = new Player(id);
    g_players[id] = player;
    ++g_numPlayers;
  }
  return player;
}

function removePlayer(id) {
  if (g_players[id]) {
    delete g_players[id];
    --g_numPlayers;
  }
}

function updatePlayer(id, msg) {
  var player = getPlayer(id);
  player.update(msg);
}

function resizeCanvas() {
  if (g_canvas.width != g_canvas.clientWidth) {
    g_canvas.width = g_canvas.clientWidth;
    tdl.log("new width:", g_canvas.width);
  }
  if (g_canvas.height != g_canvas.clientHeight) {
    g_canvas.height = g_canvas.clientHeight;
    tdl.log("new height:", g_canvas.height);
  }
}

function main() {
  g_canvas = document.getElementById("canvas");
  g_ctx = g_canvas.getContext("2d");
  connect();
  getPlayer(1);

  var then = (new Date()).getTime() * 0.001;

  render();

  function render() {
    var now = (new Date()).getTime() * 0.001;
    var elapsedTime = now - then;
    then = now;
    tdl.webgl.requestAnimationFrame(render, canvas);

    for (var id in g_players) {
      g_players[id].process(elapsedTime);
    }

    resizeCanvas();
    g_ctx.clearRect(0, 0, g_canvas.width, g_canvas.height);
    for (var id in g_players) {
      g_players[id].draw(g_ctx);
    }
  }

}
</script>
</head>
<body>
<div id="outer">
<canvas id="canvas"></canvas>
</div>
</body>
</html>

